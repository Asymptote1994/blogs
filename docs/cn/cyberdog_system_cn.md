# cyberdog_system设计文档

# 概述

cyberdog_system是机器人全局状态码及错误码的封装包。

系统运行时返回的错误码由模块码值+具体错误码值组成，具体错误码值中0-20为系统级别，21-100为模块自定义。

特别地，0为结果正确，只返回0，不包含模块码值；

如，3002，代表30为运动模块，02代表系统级别的未初始化；

## 全局状态码

全局状态码分：未初始化、设置、自检、活跃、非活跃、低功耗、保护模式、升级模式、错误状态、关机状态、未知状态。其中，在使用的状态：未初始化、设置、活跃、低功耗、保护模式、升级模式、错误状态。

```C++
enum class MachineState : uint8_t
{
  MS_Uninitialized = 0,    // 未初始化
  MS_SetUp = 1,            // 设置
  MS_TearDown = 2,         // 关机状态
  MS_SelfCheck = 3,        // 自检
  MS_Active = 4,           // 活跃
  MS_DeActive = 5,         // 非活跃
  MS_Protected = 6,        // 保护模式
  MS_LowPower = 7,         // 低功耗
  MS_OTA = 8,              // 升级
  MS_Error = 9,            // 错误
  MS_Unkown = 10           // 未知
};  // enum class MachineState
```

## 错误码

错误码分：全局错误码和模块自定义错误码。全局错误码是所有模块公用的错误码，主要包含如下代码块的错误码信息。模块自定义错误码，由模块节点按照自己的业务需求实现自定义错误码。

### 全局错误码

| 码值 | 说明                       | 码值 | 说明                         |
| ---- | -------------------------- | ---- | ---------------------------- |
| 0    | OK                         |      |                              |
| 1    | 无特别定义的失败，统一使用 | 11   | 状态忙碌，独占性调用接口     |
| 2    | 未初始化                   | 12   | 硬件错误，外设、传感器类使用 |
| 3    | 状态机不允许               | 13   | 低电量                       |
| 4    | 模块状态错误               | 14   |                              |
| 5    | 网络错误                   | 15   |                              |
| 6    | 无操作权限                 | 16   |                              |
| 7    | 超时                       | 17   |                              |
| 8    | 指令不支持                 | 18   |                              |
| 9    | 自检失败                   | 19   |                              |
| 10   | 参数不合法                 | 20   |                              |

# 功能

封装了CyberdogCode类，各功能包引用返回节点模块具体的错误码信息。通过实例化CyberdogCode，传入ModuleCode（模块代码）关联具体的节点模块，在节点发生错误时，设置相关错误码：包括全局错误码和模块自定义错误码，把错误信息同步到全局管理节点（cyberdog_manager)。

```C++
template<typename Code_T>
class CyberdogCode final
{
public:
  explicit CyberdogCode(ModuleCode module_code)
  {
    ModuleImpl_ = module_code;
  }
  /**
   * @brief Get the Key Code object
   *
   * @param code 预留关键码
   * @return int32_t 转为int值的代码
   */
  int32_t GetKeyCode(KeyCode code)
  {
    return code ==
           KeyCode::kOK ? static_cast<int32_t>(KeyCode::kOK) : static_cast<int32_t>(ModuleImpl_) +
           static_cast<int32_t>(code);
  }

  /**
   * @brief 获取模块自定义结果码
   *
   * @param code 自定义结果码
   * @return int32_t 转为int值的代码
   */
  int32_t GetCode(Code_T code)
  {
    return static_cast<int32_t>(ModuleImpl_) + static_cast<int32_t>(code);
  }
};  // calss CyberdogCode
```

其中，ModuleCode代表模块代码，用于标识模块。所有模块代码如下表：

| manager          | vision      | core |                |      |                 |                |      |      |
| ---------------- | ----------- | ---- | -------------- | ---- | --------------- | -------------- | ---- | ---- |
| 模块             | 码值        | 说明 | 模块           | 码值 | 说明            | 模块           | 码值 | 说明 |
| cyberdog_manager | 100         |      | Follow         | 4100 |                 | Audio-NX       | 5000 |      |
| server           | 200,400,500 |      | AI             | 4200 |                 | Audio-Board    | 5100 |      |
| bridge-grpc      | 300         |      | MapNav         | 4300 |                 | Connector      | 5200 |      |
| bridge-net       | 600         |      | CameraServer   | 4400 |                 | Navigation     | 5300 |      |
| APP              | 700,800     |      |                |      |                 | Transmission   | 5400 |      |
|                  |             |      |                |      |                 | Fence          | 5500 |      |
|                  |             |      |                |      |                 | Aft            | 5600 |      |
|                  |             |      |                |      |                 | OTA            | 5700 |      |
|                  |             |      |                |      |                 | Model          | 5800 |      |
| device           | motion      | Face | 5900           |      |                 |                |      |      |
| 模块             | 码值        | 说明 | 模块           | 码值 | 说明            | Sport          | 7000 |      |
| device_manager   | 1000        |      | motion_manager | 3000 |                 | VP             | 8000 |      |
| LED              | 1100        |      | motion-borad   | 3100 | 运控板          | unlock_request | 9000 |      |
| Wifi             | 1300        |      | motion-utils   |      |                 |                |      |      |
| BMS              | 1400        |      |                |      |                 |                |      |      |
| Touch            | 1500        |      |                |      |                 |                |      |      |
| bluetooth        | 1600        |      |                |      |                 |                |      |      |
|                  |             |      |                |      |                 |                |      |      |
|                  |             |      |                |      |                 |                |      |      |
| sensor           | bridges     |      |                |      |                 |                |      |      |
| 模块             | 码值        | 说明 | 模块           | 码值 | 说明            |                |      |      |
| sensor_manager   | 2000        |      | bes_transmit   | 6000 | 后端通信        |                |      |      |
| Lidar            | 2100        |      | cyberdog_grpc  | 6100 | app请求的错误码 |                |      |      |
| ToF              | 2200        |      |                |      |                 |                |      |      |
| Ultrasonic       | 2300        |      |                |      |                 |                |      |      |
| GPS              | 2400        |      |                |      |                 |                |      |      |

模块自定义错误码表：

| 模块                                                         | 错误码                                                       | 含义                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------ |
| LED(1100)                                                    | 21                                                           | 当前请求的target参数为空或者不在可选列表中             |
|                                                              | 22                                                           | 当前请求的client为空或者不在预设的优先级列表中         |
|                                                              | 23                                                           | 当前请求的mode参数为空或者不在可选列表中               |
|                                                              | 24                                                           | 当前请求的effect参数为空或者不在可选列表中             |
|                                                              | 25                                                           | 当前请求优先级较低，无法立即执行请求灯效               |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| cyberdog_manager(100)                                        | 21                                                           | 在数据库中查询用户信息失败                             |
|                                                              | 22                                                           | 操作用户账户失败，对数据库操作失败                     |
|                                                              | 23                                                           | 操作用户账户失败，声纹服务调用出错                     |
|                                                              | 24                                                           | 操作用户账户失败，人脸服务调用出错                     |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| cyberdog_face(5900)                                          | 21                                                           | 人脸录入失败                                           |
|                                                              |                                                              |                                                        |
| sensor_manager(2000) Lidar——2100 ToF——2200 Ultrasonic——2300 GPS——2400 | 无                                                           |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| device_manager(1000) Led——1100 MiniLed——1200 Wifi——1300 Bms——1400 Touch——1500 | 无                                                           |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| bes_transmit（6000）                                         | 21                                                           | 空URL                                                  |
|                                                              | 22                                                           | 信息服务query_divice_info获取失败                      |
|                                                              | 23                                                           | 无效SN                                                 |
|                                                              | 24                                                           | JSON解析错误                                           |
|                                                              | 25                                                           | HTTP请求错误                                           |
|                                                              | 26                                                           | 文件打开失败                                           |
|                                                              |                                                              |                                                        |
| cyberdog_audio(5100)                                         | 21                                                           | 开启/禁用麦克风失败                                    |
|                                                              | 22                                                           | 获取麦克风状态失败                                     |
|                                                              | 23                                                           | 设置小爱token失败                                      |
|                                                              | 24                                                           | 声纹训练开始/取消失败                                  |
|                                                              | 25                                                           | 设置狗子昵称失败                                       |
|                                                              | 26                                                           | 设置音量失败                                           |
|                                                              | 27                                                           | 获取音量失败                                           |
|                                                              | 28                                                           | 语音控制垂域开关使能失败                               |
|                                                              | 29                                                           | 获取语音控制垂域开关状态失败                           |
|                                                              | 30                                                           | 切换环境失败                                           |
|                                                              |                                                              |                                                        |
| motion_manager(3000)                                         | 3                                                            | 状态机不允许                                           |
|                                                              | 8                                                            | 指令不支持                                             |
|                                                              | 9                                                            | 自检失败                                               |
|                                                              | 10                                                           | 参数不合法                                             |
|                                                              | 11                                                           | 状态忙碌                                               |
|                                                              | 13                                                           | 电池电量低                                             |
|                                                              | 21                                                           | 运控板切换步态错误 ESTOP                               |
|                                                              | 22                                                           | 运控板切换步态错误 BAN_TRANS                           |
|                                                              | 23                                                           | 运控板切换步态错误 EDAMP                               |
|                                                              | 24                                                           | 运控板切换步态错误 LIFTED                              |
|                                                              | 25                                                           | 运控板切换步态高温                                     |
|                                                              | 26                                                           | 运控板切换步态低电量                                   |
|                                                              | 27                                                           | 运控板切换步态超时                                     |
|                                                              | 28                                                           | 动作执行超时                                           |
|                                                              | 29                                                           | 动作执行失败                                           |
|                                                              | 31                                                           | 动作自定义失败                                         |
|                                                              | 32                                                           | 电机错误                                               |
|                                                              | 33                                                           | 电机过温                                               |
|                                                              | 34                                                           | 电机过流                                               |
|                                                              | 35                                                           | 与运控板通讯失败                                       |
|                                                              | 40                                                           | 急停状态                                               |
|                                                              | 41                                                           | 周边有障碍物不能站立                                   |
| cyberdog_ai_sports(7000)                                     | 无                                                           |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| cyberdog_wifi(1500)                                          | 1324                                                         | 没找到ssid                                             |
|                                                              | 1325                                                         | 密码错误                                               |
|                                                              | 1326                                                         | 其它错误                                               |
|                                                              | 1334                                                         | 被打断                                                 |
|                                                              | 1335                                                         | 超时                                                   |
|                                                              | 1336                                                         | 隐藏的ssid，需要更多时间连接                           |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| cyberdog_bluetooth(1600)                                     | 1621                                                         | 蓝牙连接流程中失败                                     |
|                                                              | 1622                                                         | uwb连接失败                                            |
|                                                              | 1623                                                         | 获取uwb的session id失败                                |
|                                                              | 1624                                                         | 所请求设备非小米设备                                   |
|                                                              | 1625                                                         | 获取电量失败                                           |
|                                                              | 1626                                                         | 连接蓝牙操作失败                                       |
|                                                              | 1627                                                         | 正在连接流程中，无法再次发起连接流程                   |
|                                                              | 1628                                                         | 固件升级中                                             |
|                                                              | 1629                                                         | 底层扫描失败                                           |
| connector(8100)                                              | 8121                                                         | WiFi名称错误                                           |
|                                                              | 8122                                                         | WiFi密码错误                                           |
|                                                              | 8123                                                         | WiFi提供者IP错误                                       |
|                                                              | 8124                                                         | WiFi连接超时错误                                       |
| algorithm_manager                                            | algorithm_manager只有一个stop_task服务，返回0或1表示success和fail。没有相关的错误码 |                                                        |
| map_label_server                                             | map_label_server的get_label服务返回0-4共计5个状态码表示对应的状态，没有错误码。out_door服务返回true或false表示室内或室外，没有错误码 |                                                        |
| cyberdog_train(8200)                                         | 8221                                                         | 等待access-token                                       |
|                                                              | 8222                                                         | 小爱服务器未返回数据或数据解析错误                     |
|                                                              | 8223                                                         | 查询结束，当前训练列表中未匹配到该trigger              |
|                                                              | 8224                                                         | 同名trigger已存在，不可重复添加                        |
|                                                              | 8225                                                         | 系统保留训练词，不可编辑                               |
|                                                              |                                                              |                                                        |
|                                                              | 8226                                                         | 其它错误                                               |
|                                                              |                                                              |                                                        |
| unlock_request                                               | 9010                                                         | 解锁成功                                               |
|                                                              | 9110                                                         | 解锁失败                                               |
| cyberdog_grpc                                                | 321                                                          | 请求的ros服务返回结果超时                              |
|                                                              | 322                                                          | 请求的ros服务不可用                                    |
|                                                              | 323                                                          | Json解析错误                                           |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
|                                                              |                                                              |                                                        |
| 新版OTA错误码 OTA（5700）                                    | 5721                                                         | 状态机异常                                             |
|                                                              | 5722                                                         | 趴下异常                                               |
|                                                              | 5723                                                         | 趴下异常                                               |
|                                                              | 5724                                                         | 电池电量低                                             |
|                                                              | 5725                                                         | 电池未充电                                             |
|                                                              | 5726                                                         | 已解锁                                                 |
|                                                              | 5727                                                         | 构建环境失败                                           |
|                                                              | 5728                                                         | 空间不足                                               |
|                                                              | 5729                                                         | 基础信息异常                                           |
|                                                              | 5730                                                         | 捕获到异常                                             |
|                                                              | 5731                                                         | 创建工作空间失败                                       |
|                                                              | 5732                                                         | 构建配置文件失败                                       |
|                                                              | 5733                                                         | 存在无效url                                            |
|                                                              | 5734                                                         | 构建下载目标连接文件失败                               |
|                                                              | 5735                                                         | 清除工作空间失败                                       |
|                                                              | 5736                                                         | 等待网络恢复超时                                       |
|                                                              | 5737                                                         | 无法解析主机地址                                       |
|                                                              | 5738                                                         | 重置进展失败                                           |
|                                                              | 5739                                                         | 更新进展失败                                           |
|                                                              | 5740                                                         | 调用流程错误                                           |
|                                                              | 5741                                                         | 下载目标文件失败                                       |
|                                                              | 5742                                                         | 升级目标文件失败                                       |
|                                                              | 5743                                                         | 重启设备失败                                           |
|                                                              | 5744                                                         | 重置设备失败                                           |
|                                                              | 5745                                                         | 获取目标磁盘信息失败                                   |
|                                                              | 5746                                                         | 删除目标文件失败                                       |
|                                                              | 5747                                                         | 其他原因导致的失败                                     |
| cyberdog_vp_abilityset                                       | 7921                                                         | 失败                                                   |
|                                                              | 7922                                                         | 未初始化模块                                           |
|                                                              | 7923                                                         | 状态机不允许                                           |
|                                                              | 7924                                                         | 模块状态错误                                           |
|                                                              | 7925                                                         | 网络错误                                               |
|                                                              | 7926                                                         | 无操作权限                                             |
|                                                              | 7927                                                         | 超时                                                   |
|                                                              | 7928                                                         | 指令不支持                                             |
|                                                              | 7929                                                         | 自检失败                                               |
|                                                              | 7930                                                         | 参数不合法                                             |
|                                                              | 7931                                                         | 状态忙碌                                               |
|                                                              | 7932                                                         | 硬件错误                                               |
|                                                              | 7941                                                         | 命令等待执行                                           |
|                                                              | 7942                                                         | 请求循环服务中断                                       |
|                                                              | 7943                                                         | 请求循环服务超时/延迟                                  |
|                                                              | 7944                                                         | 无数据更新                                             |
|                                                              | 7945                                                         | 客户端在请求服务出现时被打断                           |
|                                                              | 7946                                                         | 等待服务出现（启动）超时                               |
|                                                              | 7947                                                         | 请求服务中断                                           |
|                                                              | 7948                                                         | 请求服务被拒绝                                         |
|                                                              | 7949                                                         | 请求服务超时/延迟                                      |
|                                                              | 7950                                                         | 请求动作超时/延迟                                      |
|                                                              | 7951                                                         | 请求动作被拒绝                                         |
|                                                              | 7952                                                         | 等待动作结果超时/延迟                                  |
|                                                              | 7961                                                         | 运控异常                                               |
| cyberdog_vp_engine                                           | 8021                                                         | 非json格式                                             |
|                                                              | 8022                                                         | type字段，类型无效                                     |
|                                                              | 8023                                                         | id字段，id无效                                         |
|                                                              | 8024                                                         | target_id字段，id无效                                  |
|                                                              | 8025                                                         | describe字段，描述无效                                 |
|                                                              | 8026                                                         | style字段，样式无效                                    |
|                                                              | 8027                                                         | operate字段，操作无效                                  |
|                                                              | 8028                                                         | mode字段，模式无效                                     |
|                                                              | 8029                                                         | condition字段，条件无效                                |
|                                                              | 8030                                                         | body字段，主体无效                                     |
|                                                              | 8041                                                         | 无法创建路径                                           |
|                                                              | 8042                                                         | 无法打开文件                                           |
|                                                              | 8043                                                         | body字段语法异常，无法构建                             |
|                                                              | 8044                                                         | 无法注册                                               |
|                                                              | 8045                                                         | 无法更新列表                                           |
|                                                              | 8046                                                         | 无法执行                                               |
|                                                              | 8047                                                         | 当前操作非法                                           |
|                                                              | 8048                                                         | 请求错误                                               |
|                                                              | 8049                                                         | 其他错误                                               |
|                                                              | 8050                                                         | 装饰身体失败                                           |
|                                                              | 8051                                                         | 服务被打断                                             |
|                                                              | 8052                                                         | 等待服务上线超时                                       |
|                                                              | 8053                                                         | 请求服务超时                                           |
| APP                                                          | 701                                                          | 网络请求超时，处理GRPC（DEADLINE_EXCEEDED:......）错误 |